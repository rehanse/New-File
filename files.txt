
<button mat-icon-button [matMenuTriggerFor]="fxMenu" #trigger="matMenuTrigger">
  fx
</button>

<mat-menu 
  #fxMenu="matMenu" 
  class="fx-popover-menu"
  yPosition="below" 
  xPosition="after"
  [overlapTrigger]="false"
  [hasBackdrop]="true"
  (closed)="onCancel()"> <!-- optional safety -->
  
  <div class="fx-container" (click)="$event.stopPropagation()">
    <mat-form-field appearance="outline" class="fx-input">
      <input matInput [(ngModel)]="formula" placeholder="Enter formula">
    </mat-form-field>

    <div class="fx-actions">
      <button mat-button color="primary" (click)="onOk()">OK</button>
      <button mat-button (click)="onCancel()">Cancel</button>
    </div>
  </div>
</mat-menu>

onOk() {
  this.formulaApplied.emit({ rowIndex: this.rowIndex, col: this.colKey, formula: this.formula });
  this.menuTrigger.closeMenu(); // close only when OK
  this.formula = '';
}

onCancel() {
  this.menuTrigger.closeMenu(); // close only when Cancel
  this.formula = '';
}
